<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>k-center</title>
	<style>
		body {
			padding:1em;
			margin:1em;
			background-color:#FFF;
		}
		#tasks {
			border: solid black 1px;
			float: left;
			width: 25%;
		}
		#results {
			border: solid black 1px;
			width: 70%;
			float: right;
		}
	</style>
    <script>
		var computation_server = 'http://localhost:8887'

        function update_tasks() {
            var table = document.getElementById('tasks');
            var request = new XMLHttpRequest();
            request.open('GET', computation_server + '/tasks');

            request.onreadystatechange = function() {
                if (request.readyState == 4) {
                    data = JSON.parse(request.responseText);
					var new_inner = '<tr><th>Status</th><th>Description</th><th>More</th></tr>';
                    for (uuid in data) {
                        new_inner += '<tr><td>' + data[uuid]['state'] + 
									 '</td><td>' + data[uuid]['description'];
						if (data[uuid]['state'] == 'finished') {
							new_inner += '<td><a href="javascript:show_result(\'' + data[uuid]['uri']  + '\');">Show</a></td>';
						}
						new_inner += '</tr>';
						
                    }
					table.innerHTML = new_inner;
                }
            }
            request.send();
            setTimeout(update_tasks, 1000);
        }

		function show_result(uri) {
			var results = document.getElementById('results');
			var request = new XMLHttpRequest();
            request.open('GET', computation_server + uri);
			
			request.onreadystatechange = function() {
                if (request.readyState == 4) {
                    data = JSON.parse(request.responseText);
					var innerHTML = '<table>';
					innerHTML += '<tr><th>Description</th></td><td>' + data['description'] + '</td></tr>';
					innerHTML += '<tr><th>Result</th><td>';
					for (p in data['result']) {
						innerHTML += '(' + data['result'][p] + '), '
					}
					innerHTML += '</td></tr><tr><th>Objective</th><td>'
					innerHTML += data['objective']
					innerHTML += '</td></tr><tr><th>Visualisation</th></td><td>';
					innerHTML += '<img src="' + computation_server + data['img'] + '" / >';
					innerHTML += '</td></tr></table>'
					
					results.innerHTML = innerHTML;
                }
            }
            request.send();
		}

		function shedule_task() {
			var form = document.getElementById('new_task_form');
			var request = new XMLHttpRequest();
            request.open('GET', computation_server + '/geometric/' + form.instance.value + '/' + form.algorithm.value + '/' + form.k.value);
			request.send();
		}

		function update_task_form() {
			var container = document.getElementById('task_form');
			var args = [];
			var arg_fields = container.children[0].getElementsByClassName('task_arg');
			for (i=0; i<arg_fields.length; i++) {
				args.push(get_value(arg_fields[i]));
			}

			var uri = computation_server + '/algorithms';
			for (arg in args)
				uri = uri + '/' + args[arg];
			var request = new XMLHttpRequest();
            request.open('GET', uri);

			request.onreadystatechange = function() {
                if (request.readyState == 4) {
					if (request.status == 200) {
                    	var data = JSON.parse(request.responseText);
					} else {
						var data = {'suggestions': undefined};
					}
					if (data['suggestions']) {

						var form = document.createElement('form');
						form.innerText = data['title'];
						form.setAttribute('id', 'task_form');
						for (arg in args) {
							var input = document.createElement('input');
							input.setAttribute('id', arg);
							input.setAttribute('type', 'hidden');
							input.setAttribute('class', 'task_arg');
							input.setAttribute('value', args[arg]);
							form.appendChild(input);
						}

						var select = document.createElement('select');
						select.setAttribute('id', args.length);
						select.setAttribute('class', 'task_arg');
						var innerHTML = '';
						for (i in data['suggestions']) {
							innerHTML += '<option>' + data['suggestions'][i] + '</option>'
						}
						select.innerHTML = innerHTML;
						form.appendChild(select);

						var button = document.createElement('button');
						button.setAttribute('onclick', 'update_task_form();');
						button.setAttribute('type', 'button');
						button.innerText = 'Weiter';
						form.appendChild(button);

						container.innerHTML = form.outerHTML;
					} else {
						var form = document.createElement('form');
						form.innerText = 'Task wurde gestartet.'
						var button = document.createElement('button');
						button.setAttribute('onclick', 'update_task_form();');
						button.setAttribute('type', 'button');
						button.innerText = 'Neuer Task';
						form.appendChild(button);
						container.innerHTML = form.outerHTML;
					}
                }
            }
            request.send();
		}

		function get_value(item) {
			var result = item.getAttribute('value');
			if (result == null) {
				var selected = item.childNodes[item.selectedIndex];
				if (selected)
					result = selected.getAttribute('value')||selected.innerText;
			}
			return result;
		}

        document.addEventListener("DOMContentLoaded", update_tasks, false);
		document.addEventListener("DOMContentLoaded", update_task_form, false);
    </script>
</head>
<body>
	<h1>k-center problems</h1>
	<p>
		k-center bla bla bla.<br />
		Geometric, on graphs, etc...
	</p>
	<table id="tasks">
		<tr>
			<th>Status</th>
			<th>Description</th>
			<th>More</th>
		</tr>
	</table>
	<div id="results">	
	</div>
	<br clear="both" />
	<div id="task_form">
		<form />
	</div>
	<p>
		random instance
	</p>
	<p>
		munich
	</p>
	<h2>Algorithms</h2>
</body>
</html>
